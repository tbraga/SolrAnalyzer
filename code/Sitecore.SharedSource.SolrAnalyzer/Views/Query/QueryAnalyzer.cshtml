@model Sitecore.SharedSource.SolrAnalyzer.Models.Boards.IStatisticsBoard

@{
    Layout = "~/Views/Query/SolrAnalyzerLayout.cshtml";
}

<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<style>
    
    .chosen-rtl .chosen-drop { left: -9000px; }

    .ui-autocomplete-loading {
         background: white url("images/ui-anim_basic_16x16.gif") right center no-repeat;
     }

    .ui-widget-header {
        background-color: #4286f4;
    }

    .slider-range, .filter {
        margin-left: 5px;
        margin-right: 5px;
        margin-top: 5px;
    }

    body {
        font-family: Arial, Helvetica, sans-serif;
    }

    table {
        font-size: 1em;
    }

    .ui-draggable, .ui-droppable {
        background-position: top;
    }

    .emotion-items {
        margin: 15px;
    }

    .emotion-item {
        margin-bottom: 15px;
    }

    .emotion-item input {
        text-align: center;
    }

    .filter-title, .filter-value {
        font-weight: bold;
    }

    .section-title {
        padding-left: 2px;
        height: 35px;
        font-weight: bold;
        background-color: #f0f0f0;
        border-bottom: 1px solid #cccccc;
        border-top: 1px solid #cccccc;
        line-height: 35px;
        vertical-align: middle;
    }

    .cognitiveSearchButton {
        margin-right: 15px;
        float: right;
    }
</style>

<h1 class="modal-heading">Solr Analyzer : Query Analyzer</h1>
<div class="frame">
    <div class="rte-search-form">
        <form method="post" action="/SolrAnalyzer/Query/QueryAnalysis_ByIndex">
            <div class="search-results">
                <div id="content">
                    <div id="metrics-query-analysis" ng-class="showAllStacktraces ? 'expanded' : 'collapsed'" class="ng-scope collapsed">
                        <div class="page-content">
                            <div class="page-title">Description:</div>
                            <div class="page-summary">
                                This page will analyze the performance of the queries that have been running against Solr. Each query is an HTTP call and has a consequence in
                                downloading the requested data. Try to tune your queries to be lean, this will help in downloading a smaller amount of data while applying the
                                same intended value. You will also save on bandwidth between the server and the requestor.
                            </div>
                            <div class="page-title">Keep in mind:</div>
                            <div class="page-summary">
                                <ul>
                                    <li>
                                        Select only the fields on the document you need for your scenario. If you only need 10 of the 50 fields for a specific query only call those 10,
                                        this will reduce the amount of bytes during the response download.
                                    </li>
                                    <li>
                                        Make sure you are only requesting the number of documents you need by using the ROWS parameter within your request. If you need to paginate you
                                        can use the ROWS parameter in combination with the START parameter.
                                    </li>
                                    <li>
                                        Caching: Optimize the document cache on each of your heavily utilized cores. Specifically look at the eviction rate and the hit ratio.
                                    </li>
                                    <li>
                                        By running the query through the Chrome browser, you can look at the network tab of Chrome's Developer Tools and see the byte size returned from Solr
                                        as well as the response time. Getting these two numbers to perform are key to a well optimized environment.
                                    </li>
                                </ul>
                            </div>
                            <div class="page-title">Filter by Index:</div>
                            <select id="idxDropdown">
                                <option></option>
                                @{
                                    foreach (var idx in Model.Queries.Select(x => x.Index).Distinct().OrderBy(x => x))
                                    {
                                        <option value="@idx">@idx</option>
                                    }
                                }
                            </select>
                            <div class="page-summary"></div>
                        </div>
                    </div>

                    <table id="query-analysis" class="ng-scope">
                        <thead>
                        <tr>
                            <th><b>Index</b></th>
                            <th><b>Query</b></th>
                            <th><b>Rows</b></th>
                            <th><b>Documents Found</b></th>
                            <th><b>Documents Returned</b></th>
                            <th><b>Time (ms)</b></th>
                            <th><b>Bytes</b></th>
                        </tr>
                        </thead>
                        <tbody>
                        @{
                            foreach (var query in Model.Queries)
                            {
                                <tr>
                                    <td>@query.Index</td>
                                    <td>@query.GetAnchor()</td>
                                    <td>@query.RowsRequested</td>
                                    <td>@query.DocumentsFound</td>
                                    <td>@string.Format("{0:n0}", query.DocumentsReturned)</td>
                                    <td>@string.Format("{0:n0}", query.Timespan.TotalMilliseconds)</td>
                                    <td>@string.Format("{0:n0}", query.Bytes)</td>
                                </tr>
                            }
                        }
                        <tr class="query-analysis-totals">
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <td id="totDocsReturned" style="color: red; font-weight: bold;">@string.Format("{0:n0}", Model.TotalNumDocsReturned)</td>
                            <td id="totTime" style="color: red; font-weight: bold;">@string.Format("{0:n0}", Model.TotalTime)</td>
                            <td id="totBytes" style="color: red; font-weight: bold;">@string.Format("{0:n0}", Model.TotalPayload)</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="scWizardButtons">
                <button class="form-cancel scButton">Close</button>
            </div>
        </form>
        <div class="progress-indicator">
            <img src="/sitecore/shell/themes/standard/Images/ProgressIndicator/sc-spinner32.gif" />
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/prototype/1.7.0.0/prototype.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    
    <script>
        jQuery(function() {
            jQuery('#idxDropdown').on('change',
                function(e) {
                    event.preventDefault();
                    var selectedIdx = jQuery('#idxDropdown').val();

                    jQuery(".progress-indicator").show();

                    jQuery.post(
                        jQuery('form').attr("action"),
                        {
                            idx: selectedIdx
                        }
                    );
                });
        });

        //                .done(function (r) {
        //                for (var i = 0; i < r.Results.length; i++) {
        //                    var d = r.Results[i];
        //                    if (d.Url != undefined) {
        //                        jQuery("#query-analysis tbody").append("<tr><td>" + d.Index + "</td><td>" + d.Anchor + "</td><td>" + d.RowsRequested + "</td><td>" + d.DocumentsFound + "</td><td>0</td>
        //                            <td>1</td>
        //                            <td>447</td>
        //                        </tr><div class='result-img-wrap'><img src=\"" + d.Url + "\" alt=\"" + d.Alt + "\" /></div>");
        //                    }
        //                }

        //                jQuery(".result-img-wrap")
        //                    .on("click", function () {
        //                        jQuery(".result-items .selected").removeClass("selected");
        //                        jQuery(this).addClass("selected");
        //                    });
        //            }).always(function () {
        //                jQuery(rteSearchForm + " .progress-indicator").hide();
        //            });


        //            jQuery.post(
        //                jQuery(imageSearchForm).attr("action"),
        //                    {
        //                        formParameters: [],
        //                        tagParameters: tags,
        //                        rangeParameters: ranges,
        //                        gender: gender,
        //                        glasses: glasses,
        //                        language: langValue,
        //                        db: dbValue
        //                    }
        //                )


        //        });
        //})
    </script>
</div>